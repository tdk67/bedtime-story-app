<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Weaver</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700&display=swap');

        body {
            margin: 0;
            font-family: 'Lora', serif;
            color: #3a2411;
            background-image: url('data/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .options-pane {
            position: absolute;
            height: 75%;
            padding: 1%;
            overflow-y: auto;
            box-sizing: border-box;
            top: 12%;
            right: 12%;
            width: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .story-pane {
            position: absolute;
            padding: 1%;
            overflow-y: auto;
            box-sizing: border-box;
            top: 1%;
            left: 11%;
            width: 39%;
            height: auto;
        }

        .audio-player {
            width: 80%;
            display: block;
            margin: 0 auto;
            margin-bottom: 1rem;
        }

        .main-illustration {
            width: 75%;
            display: block;
            margin: 0 auto;
            border-radius: 15px;
        }

        .story-text {
            font-size: 1.1rem;
            text-align: left;
            margin-top: 1rem;
            width: 80%;
            margin: 1rem auto 0 auto;
        }

        .choice-box {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            position: relative; /* For the spinner */
        }
        
        /* Spinner for loading choices */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4b3a26;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }

        .choice-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .choice-button {
            padding: 15px;
            font-family: 'Lora', serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            background-color: rgba(210, 180, 140, 0.7);
            border: 1px solid #4b3a26;
            border-radius: 30px;
            text-align: left;
            padding-left: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s, opacity 0.3s;
            white-space: normal;
        }
        
        .choice-button:hover:not(:disabled) {
            background-color: rgba(193, 163, 120, 0.9);
        }

        .choice-button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <main>
        <section class="story-pane">
            <audio class="audio-player" id="audioPlayer" controls></audio>
            <img class="main-illustration" id="mainIllustration" src="" alt="Main Story Illustration">
            <p class="story-text" id="storyText"></p>
        </section>

        <aside class="options-pane" id="optionsPane">
            </aside>
    </main>

    <script>
        const BACKEND_URL = "http://127.0.0.1:8000";

        const audioPlayer = document.getElementById('audioPlayer');
        const mainIllustration = document.getElementById('mainIllustration');
        const storyText = document.getElementById('storyText');
        const optionsPane = document.getElementById('optionsPane');
        
        let currentStoryData = {};

        /**
         * Updates the page and triggers pre-generation for all new choices.
         */
        function updatePage(storyData) {
            currentStoryData = storyData;

            audioPlayer.src = `data:audio/mp3;base64,${storyData.narration_audio_b64}`;
            audioPlayer.play().catch(e => console.warn("Audio autoplay prevented by browser."));
            mainIllustration.src = `data:image/png;base64,${storyData.main_illustration_b64}`;
            storyText.textContent = storyData.story_text;
            optionsPane.innerHTML = ''; 

            if (storyData.choices && storyData.choices.length > 0) {
                const heading = document.createElement('h4');
                heading.textContent = "What should we do next?";
                optionsPane.appendChild(heading);

                storyData.choices.forEach(choice => {
                    const choiceBox = document.createElement('div');
                    choiceBox.className = 'choice-box';

                    const choiceImage = document.createElement('img');
                    choiceImage.className = 'choice-image';
                    choiceImage.src = `data:image/png;base64,${choice.image_b64}`;
                    choiceImage.alt = choice.text;

                    const choiceButton = document.createElement('button');
                    choiceButton.className = 'choice-button';
                    choiceButton.textContent = choice.text;
                    choiceButton.disabled = true;

                    const spinner = document.createElement('div');
                    spinner.className = 'spinner';
                    
                    choiceBox.appendChild(choiceImage);
                    choiceBox.appendChild(choiceButton);
                    choiceBox.appendChild(spinner);
                    optionsPane.appendChild(choiceBox);

                    preGenerateChoice(choice, choiceButton, spinner);
                });
            } else {
                optionsPane.innerHTML = `<div style="text-align: center;"><h2>The End!</h2><button class="choice-button" style="width: auto; text-align: center; padding: 15px 30px;" onclick="window.location.href='intro.html'">Start a New Adventure?</button></div>`;
            }
        }

        /**
         * Triggers generation for a single choice and enables its button when complete.
         */
        async function preGenerateChoice(choice, buttonElement, spinnerElement) {
            try {
                const config = JSON.parse(localStorage.getItem('storyConfig') || '{}');
                const payload = {
                    conversation_history: currentStoryData.conversation_history,
                    choice: choice.text,
                    config: config
                };
                
                const startResponse = await fetch(`${BACKEND_URL}/generate/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const { job_id } = await startResponse.json();

                const pollInterval = setInterval(async () => {
                    const statusResponse = await fetch(`${BACKEND_URL}/generate/status/${job_id}`);
                    const { status } = await statusResponse.json();

                    if (status === 'complete') {
                        clearInterval(pollInterval);
                        buttonElement.dataset.jobId = job_id; 
                        buttonElement.disabled = false;
                        spinnerElement.remove();
                        buttonElement.onclick = () => handleChoice(job_id);
                    } else if (status === 'failed') {
                        clearInterval(pollInterval);
                        buttonElement.textContent = "Error loading this path";
                        spinnerElement.remove();
                    }
                }, 2500);
            } catch (error) {
                console.error("Failed to pre-generate choice:", error);
                buttonElement.textContent = "Error loading this path";
                spinnerElement.remove();
            }
        }

        /**
         * Fetches the pre-generated result and updates the page.
         */
        async function handleChoice(jobId) {
            document.querySelectorAll('.choice-button').forEach(button => button.disabled = true);
            try {
                const nextSegment = await pollForResult(jobId);
                if (nextSegment) {
                    updatePage(nextSegment);
                } else {
                    throw new Error("Polling failed to return a result.");
                }
            } catch (error) {
                console.error("Failed to get next story segment:", error);
                optionsPane.innerHTML = '<h4>Oops! Something went wrong. Please <a href="intro.html">start over</a>.</h4>';
            }
        }
        
        function pollForResult(jobId) {
            return new Promise((resolve, reject) => {
                const interval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`${BACKEND_URL}/generate/status/${jobId}`);
                        const { status } = await statusResponse.json();

                        if (status === 'complete') {
                            clearInterval(interval);
                            const resultResponse = await fetch(`${BACKEND_URL}/generate/result/${jobId}`);
                            const resultData = await resultResponse.json();
                            resolve(resultData);
                        } else if (status === 'failed') {
                            clearInterval(interval);
                            reject(new Error("Generation failed on backend."));
                        }
                    } catch (error) {
                        clearInterval(interval);
                        reject(error);
                    }
                }, 1000); 
            });
        }

        window.onload = async () => {
            const completedJobId = localStorage.getItem('completedJobId');
            if (completedJobId) {
                try {
                    const initialStoryData = await pollForResult(completedJobId);
                    updatePage(initialStoryData);
                    localStorage.removeItem('completedJobId');
                } catch (error) {
                    console.error("Could not fetch story data from backend:", error);
                    optionsPane.innerHTML = '<h4>Could not load story. Please <a href="intro.html">start over</a>.</h4>';
                }
            } else {
                console.error("No job ID found in localStorage. Redirecting to intro.");
                window.location.href = 'intro.html';
            }
        };
    </script>
</body>
</html>